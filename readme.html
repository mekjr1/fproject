<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>

<title>fit a lm coeficient to get redditors  that are more active in the subreddits</title>

<script type="text/javascript">
window.onload = function() {
  var imgs = document.getElementsByTagName('img'), i, img;
  for (i = 0; i < imgs.length; i++) {
    img = imgs[i];
    // center an image if it is the only element of its parent
    if (img.parentElement.childElementCount === 1)
      img.parentElement.style.textAlign = 'center';
  }
};
</script>





<style type="text/css">
body, td {
   font-family: sans-serif;
   background-color: white;
   font-size: 13px;
}

body {
  max-width: 800px;
  margin: auto;
  padding: 1em;
  line-height: 20px;
}

tt, code, pre {
   font-family: 'DejaVu Sans Mono', 'Droid Sans Mono', 'Lucida Console', Consolas, Monaco, monospace;
}

h1 {
   font-size:2.2em;
}

h2 {
   font-size:1.8em;
}

h3 {
   font-size:1.4em;
}

h4 {
   font-size:1.0em;
}

h5 {
   font-size:0.9em;
}

h6 {
   font-size:0.8em;
}

a:visited {
   color: rgb(50%, 0%, 50%);
}

pre, img {
  max-width: 100%;
}
pre {
  overflow-x: auto;
}
pre code {
   display: block; padding: 0.5em;
}

code {
  font-size: 92%;
  border: 1px solid #ccc;
}

code[class] {
  background-color: #F8F8F8;
}

table, td, th {
  border: none;
}

blockquote {
   color:#666666;
   margin:0;
   padding-left: 1em;
   border-left: 0.5em #EEE solid;
}

hr {
   height: 0px;
   border-bottom: none;
   border-top-width: thin;
   border-top-style: dotted;
   border-top-color: #999999;
}

@media print {
   * {
      background: transparent !important;
      color: black !important;
      filter:none !important;
      -ms-filter: none !important;
   }

   body {
      font-size:12pt;
      max-width:100%;
   }

   a, a:visited {
      text-decoration: underline;
   }

   hr {
      visibility: hidden;
      page-break-before: always;
   }

   pre, blockquote {
      padding-right: 1em;
      page-break-inside: avoid;
   }

   tr, img {
      page-break-inside: avoid;
   }

   img {
      max-width: 100% !important;
   }

   @page :left {
      margin: 15mm 20mm 15mm 10mm;
   }

   @page :right {
      margin: 15mm 10mm 15mm 20mm;
   }

   p, h2, h3 {
      orphans: 3; widows: 3;
   }

   h2, h3 {
      page-break-after: avoid;
   }
}
</style>



</head>

<body>
<p>library(dygraphs) # interactive js plots
library(xts)
library(knitr)
library(dplyr)
library(ggplot2)
library(wordcloud)
library(RColorBrewer)
library&trade; # for document term matrix
library(e1071) # for naive bayes
library(stringr)</p>

<p>#read the csv containing df.
df&lt;-read.csv(&ldquo;nbasubredditfull.csv&rdquo;)</p>

<p>#read the sentiment lexico, a list of &gt;6000 sentiment lexicon gathered from Liu
#<a href="https://www.cs.uic.edu/%7Eliub/FBS/sentiment-analysis.html">https://www.cs.uic.edu/~liub/FBS/sentiment-analysis.html</a>
sent_lexicon &lt;- read.csv(&ldquo;sent_lexicon.csv&rdquo;)</p>

<p>#convert the times to UTC standards
df$created_timestamp &lt;- as.POSIXct(df$created_utc, tz = &ldquo;UTC&rdquo;, origin = &ldquo;1970-01-01&rdquo;)
df$created_date &lt;- as.Date(format(df$created_timestamp, &ldquo;%Y-%m-%d&rdquo;))</p>

<p>#read the author_flair_text to get names of teams, 
#players, and based on that, get how many users has them in their flair
#this starts from the intuition that those would be very popular flares under these subreddits
supporter_counts &lt;- df %&gt;% 
  filter(!is.na(author_flair_text)) %&gt;%
  group_by(author_flair_text) %&gt;%
  summarize(comments = n(), users = n_distinct(author))</p>

<p>#Simple table generator
kable(head(supporter_counts %&gt;% 
             select(author_flair_text, comments, users) %&gt;% 
             arrange(desc(comments)), n = 10), 
      align = &ldquo;c&rdquo;, col.names = c(&ldquo;Team&rdquo;, &ldquo;Comments&rdquo;, &ldquo;Users&rdquo;))</p>

<h1>fit a lm coeficient to get redditors  that are more active in the subreddits</h1>

<p>#and draw a  linear trendline for all subreddditors
fit_coef &lt;- coef(lm(comments~users, supporter_counts)) 
ggplot(supporter_counts, aes(x = users, y = comments)) +
  geom_point() +
  geom_text(aes(label = ifelse(users &gt; 400, author_flair_text, &ldquo;&rdquo;)), size = 4, hjust = -.05) +
  theme_light(base_size=16) + 
  labs(xlab = &ldquo;# of Unique Users&rdquo;, ylab = &ldquo;# of Comments&rdquo;) +
  xlim(c(0, 6000)) +
  ggtitle(&ldquo;Active Fans&rdquo;) + 
  geom_abline(intercept = fit_coef[1], slope = fit_coef[2])</p>

<p>#Reduce the author flair to only those equal to the names of the teams in the
#finals in their respective conferences
c_finals &lt;- df %&gt;%
  filter(author_flair_text %in% c(&ldquo;Atlanta&rdquo;,&ldquo;Hawks&rdquo;,&ldquo;Atlanta Hawks&rdquo;,&ldquo;Cleveland &rdquo;,&ldquo;Cavaliers&rdquo;,&ldquo;Cleveland Cavaliers&rdquo;,&ldquo;Golden&rdquo;,&ldquo;State&rdquo;,&ldquo;Warriors&rdquo;, &ldquo;Golden State Warriors&rdquo;,&ldquo;Houston&rdquo;,&ldquo;Rockets&rdquo;,&ldquo;Houston Rockets&rdquo;))%&gt;%
  group_by(created_date, author_flair_text) %&gt;%
  dplyr::summarize(comments = n())
#further subset the dataframe into individual team flairs and prepare to create a </p>

<h1>a Time Series plot only for the four teams</h1>

<p>hw &lt;- filter(c_finals, author_flair_text == &ldquo;Hawks&rdquo;)
cav &lt;- filter(c_finals, author_flair_text == &ldquo;Cavaliers&rdquo;)
war &lt;- filter(c_finals, author_flair_text == &ldquo;Warriors&rdquo;)
roc &lt;- filter(c_finals, author_flair_text == &ldquo;Rockets&rdquo;)
y &lt;- cbind(&ldquo;Atlanta Hawks&rdquo; = xts(hw$comments, hw$created_date),
           &ldquo;Cleveland Cavaliers&rdquo; = xts(cav$comments, cav$created_date),
           &ldquo;Golden State Warriors&rdquo; = xts(war$comments, war$created_date),
           &ldquo;Houston Rockets&rdquo; = xts(roc$comments, roc$created_date))</p>

<p>plot_ts &lt;- function(y, ylabel, yrange){
  #using dygraph to make a time series and add the event descript to-
  #ease the analysis
  dygraph(y, main = &ldquo;Reddit Comments over NBA Conference Finals &rdquo;) %&gt;%
    dyAxis(&ldquo;x&rdquo;, drawGrid = FALSE) %&gt;%
    dySeries(&ldquo;Atlanta.Hawks&rdquo;) %&gt;%
    dySeries(&ldquo;Cleveland.Cavaliers&rdquo;) %&gt;%
    dySeries(&ldquo;Golden.State.Warriors&rdquo;) %&gt;%
    dySeries(&ldquo;Houston.Rockets&rdquo;) %&gt;%
    dyEvent(&ldquo;2015-05-19&rdquo;, &ldquo;Rockets 106 - Warrior 110&rdquo;, labelLoc = &ldquo;top&rdquo;) %&gt;%
    dyEvent(&ldquo;2015-05-20&rdquo;, &ldquo;Cavaliers 97 - 89 Hawks &rdquo;, labelLoc = &ldquo;top&rdquo;) %&gt;%
    dyEvent(&ldquo;2015-05-21&rdquo;, &ldquo;Rockets 98 - 99 Warriors&rdquo;, labelLoc = &ldquo;top&rdquo;) %&gt;%
    dyEvent(&ldquo;2015-05-22&rdquo;, &ldquo;Cavaliers 94 - 82 Hawks&rdquo;, labelLoc = &ldquo;top&rdquo;) %&gt;%
    dyEvent(&ldquo;2015-05-23&rdquo;, &ldquo;Warriors 115 - 80 Rockets&rdquo;, labelLoc = &ldquo;top&rdquo;) %&gt;%
    dyEvent(&ldquo;2015-05-24&rdquo;, &ldquo;Hawks 111 - 113 Cavaliers &rdquo;, labelLoc = &ldquo;top&rdquo;) %&gt;%
    dyEvent(&ldquo;2015-05-25&rdquo;, &ldquo;Warriors 115 -128 Houston&rdquo;, labelLoc = &ldquo;top&rdquo;) %&gt;%
    dyEvent(&ldquo;2015-05-26&rdquo;, &ldquo;Hawks 88 - Cavaliers 118&rdquo;, labelLoc = &ldquo;top&rdquo;) %&gt;%
    dyEvent(&ldquo;2015-05-27&rdquo;, &ldquo;Rockets 90- 104 Warriors&rdquo;, labelLoc = &ldquo;top&rdquo;) %&gt;%
    dyAxis(&ldquo;y&rdquo;, label = ylabel, valueRange = yrange) %&gt;%
    dyRangeSelector()
}
#call the function responsible to prepare and plot the TS graph
plot_ts(y, &ldquo;Comments&rdquo;, c(0, 5000))</p>

<p>#get the deviation from the mean to make better sense of the values
#this comes after seeing the discrepancies in th unnormalized values
mean_dev &lt;- function(d){
  d$comments/mean(d$comments) - 1
}</p>

<p>#plot again the same graph using the normalized values
hw$dev &lt;- mean_dev(hw)
cav$dev &lt;- mean_dev(cav)
war$dev &lt;- mean_dev(war)
roc$dev &lt;- mean_dev(roc)
y &lt;- cbind(&ldquo;Atlanta Hawks&rdquo; = xts(hw$dev, hw$created_date),
           &ldquo;Cleveland Cavaliers&rdquo; = xts(cav$dev, cav$created_date),
           &ldquo;Golden State Warriors&rdquo; = xts(war$dev, war$created_date),
           &ldquo;Houston Rockets&rdquo; = xts(roc$dev, roc$created_date))</p>

<p>plot_ts(y, &ldquo;NBA Conference Finals Comments as Proportion of Mean&rdquo;, c(-1, 6))</p>

<p>#create a time interval slot for capturing the activities during the game day
interval = c(as.POSIXct(&ldquo;2015-05-24 12:00:00&rdquo;, &ldquo;UTC&rdquo;), as.POSIXct(&ldquo;2015-05-25 12:00:00&rdquo;, &ldquo;UTC&rdquo;)) # (roughly) 24 hours post match</p>

<p>#fetch all comments and flair_texts between the interval
post_match = df %&gt;%
  filter(created_timestamp &gt; interval[1], created_timestamp &lt; interval[2], author_flair_text %in% c(&ldquo;Rockets&rdquo;, &ldquo;Warriors&rdquo;)) %&gt;%
  select(author_flair_text, body)
#write.csv(post_match,&ldquo;D:/DATA SCIENCE DATA/comments_game_day.csv&rdquo;)</p>

<p>library(dplyr)
#function slitly from Jeffrey Breen&#39;s seminar on twitter sentiment analysis with R
#<a href="http://jeffreybreen.wordpress.com/2011/07/04/twitter-text-mining-r-slides/">http://jeffreybreen.wordpress.com/2011/07/04/twitter-text-mining-r-slides/</a>
get_sentiment = function(sentences, poses, negs, .progress=&#39;none&#39;)
{
  # create simple array of scores with laply
  scores = laply(sentences,
                 function(sentence, poses, negs)
                 {
                   # remove punctuation
                   sentence = gsub(&ldquo;[[:punct:]]&rdquo;, &ldquo;&rdquo;, sentence)
                   # remove control characters
                   sentence = gsub(&ldquo;[[:cntrl:]]&rdquo;, &ldquo;&rdquo;, sentence)
                   # remove digits?
                   sentence = gsub(&#39;\d+&#39;, &#39;&#39;, sentence)</p>

<pre><code>               # define error handling function when trying tolower
               tryTolower = function(x)
               {
                 # create missing value
                 y = NA
                 # tryCatch error
                 try_error = tryCatch(tolower(x), error=function(e) e)
                 # if not an error
                 if (!inherits(try_error, &quot;error&quot;))
                   y = tolower(x)
                 # result
                 return(y)
               }
               # use tryTolower with sapply 
               sentence = sapply(sentence, tryTolower)

               # split sentence into words with str_split (stringr package)
               word.list = str_split(sentence, &quot;\\s+&quot;)
               words = unlist(word.list)

               # compare words to the dictionaries of positive &amp; negative terms
               pos.matches = match(words, poses)
               neg.matches = match(words, negs)

               # get the position of the matched term or NA
               # we just want a TRUE/FALSE
               pos.matches = !is.na(pos.matches)
               neg.matches = !is.na(neg.matches)

               # final score
               score = sum(pos.matches) - sum(neg.matches)
               return(score)
             }, poses, negs, .progress=.progress )
</code></pre>

<p># data frame with scores for each sentence
  scores.df = data.frame(text=sentences, score=scores)
  return(scores.df)
}</p>

<p>#get the sentiment intensity on all the comments 
sentiment = get_sentiment(post_match$body, sent_lexicon$positive, sent_lexicon$negative, .progress=&#39;text&#39;)</p>

<p>#add to a new column in the post_match d.f
post_match$sentiment&lt;- sentiment$score
junk$nm[junk$nm == &ldquo;B&rdquo;] &lt;- &ldquo;b&rdquo;
post_match$sentVal[post_match$sentiment&lt;=-2]&lt;-&ldquo;Very Negative&rdquo;
post_match$sentVal[post_match$sentiment==-1]&lt;-&ldquo;Negative&rdquo;
post_match$sentVal[post_match$sentiment==0]&lt;-&ldquo;Neutral&rdquo;
post_match$sentVal[post_match$sentiment&gt;=2]&lt;-&ldquo;Very Positive&rdquo;
post_match$sentVal[post_match$sentiment==1]&lt;-&ldquo;Positive&rdquo;</p>

<h1>boxplot</h1>

<p>qplot(author_flair_text, sentiment,data=post_match,fill = author_flair_text,geom=c(&ldquo;boxplot&rdquo;, &ldquo;jitter&rdquo;),
      main=&ldquo;Sentiment by Team&rdquo;,
      xlab=&ldquo;Teams&rdquo;, ylab=&ldquo;Sentiment intensity&rdquo;)</p>

<p>#Create a list of emotion polarity and intensities
emotion_list = levels(factor(post_match$sentVal))
emot_numb = length(emotion_list)
emotion.coments = rep(&ldquo;&rdquo;, emot_numb)</p>

<p>for (i in 1:emot_numb)
{
  #tmp = post_match$body[post_match$sentVal == emotion_list[i]]
  tmp=  subset( post_match$body, post_match$sentVal == emotion_list[i])
  emotion.coments[i] = paste(tmp, collapse=&ldquo; &rdquo;)
}</p>

<h1>remove stopwords</h1>

<p>emotion.coments = removeWords(emotion.coments, stopwords(&ldquo;english&rdquo;))</p>

<h1>create corpus</h1>

<p>corpus = Corpus(VectorSource(emotion.coments))
tdm = TermDocumentMatrix(corpus)
tdm = as.matrix(tdm)
colnames(tdm) = emotion_list</p>

<h1>make a word cloud to give a sense of what is actually going on</h1>

<p>comparison.cloud(tdm, max.words = 1000, colors = brewer.pal(emot_numb, &ldquo;Dark2&rdquo;),
                 scale = c(3,.5), random.order = FALSE, title.size = 1.5)</p>

</body>

</html>
